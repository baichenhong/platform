#!/bin/bash -e

function generate_username {
  local DEFAULT_USERNAME='admin'
  local DEFAULT_LEN=12
  local DEFAULT_RANGE="a-np-zA-NP-Z1-9" # Alphanumeric except o,O,0

  echo $(pad_string ${1-$DEFAULT_USERNAME} ${2-$DEFAULT_LEN} ${3-$DEFAULT_RANGE})
}

function generate_password {
  local DEFAULT_LEN=12
  local DEFAULT_RANGE="a-np-zA-NP-Z1-9-_" # Dash, underscore, Alphanumeric except o,O,0
  local DEFAULT_IGNORE="^-"

  echo $(random_string ${1-$DEFAULT_LEN} ${2-$DEFAULT_RANGE} ${3-$DEFAULT_IGNORE})
}

function random_string {
  local DEFAULT_LEN=12
  local DEFAULT_RANGE="a-zA-Z0-9"

  local len=${1-$DEFAULT_LEN}
  local range=${2-"${DEFAULT_RANGE}"}
  local omit=${3-""}

  local rnd=$(head -n 50 /dev/urandom | tr -dc $range | fold -w $len)
  [ -n "${omit}" ] && rnd=$(echo "${rnd}" | grep -v "${omit}")
  echo $(echo "${rnd}" | head -n1)
}

function pad_string {
  local str=$1
  local len=$2
  local pattern=$3

  local remain=$(( $len - ${#str} ))
  if [ "$remain" -ge 1 ]; then
    local rnstr=$(random_string $remain $pattern)
    str="${str}${rnstr}"
  fi
  echo $str
}

ln -s /usr/local/cwas/lib ${CLOUDWAY_CWAS_DIR}/
mkdir -p ${CLOUDWAY_CWAS_DIR}/{data,run}

username=$(generate_username)
password=$(generate_password)

cwctl setenv --export CLOUDWAY_CWAS_ADMIN_USERNAME "$username"
cwctl setenv --export CLOUDWAY_CWAS_ADMIN_PASSWORD "$password"

echo ""
echo "Please make note of these credentials:"
echo ""
echo "   Admin user name: $username"
echo "   Admin password:  $password"
echo ""
