#!/bin/bash -eu

# add our user and group first to make sure their IDs get assigned consistently, regardless of whatever
# dependencies get added
groupadd -r mysql && useradd -r -g mysql mysql

# install required packages
apt-get update
apt-get install -y --no-install-recommends perl libaio1 pwgen wget
rm -rf /var/lib/apt/lists/*

export MYSQL_MAJOR=5.5
export MYSQL_VERSION=5.5.49 

# download and install mysql tarball
# note: we're pulling the *.asc file from mysql.he.net instead of dev.mysql.com because the official mirror 404s that file for whatever reason - maybe it's at a different path?
wget "http://dev.mysql.com/get/Downloads/MySQL-$MYSQL_MAJOR/mysql-$MYSQL_VERSION-linux2.6-x86_64.tar.gz" -O mysql.tar.gz
wget "http://mysql.he.net/Downloads/MySQL-$MYSQL_MAJOR/mysql-$MYSQL_VERSION-linux2.6-x86_64.tar.gz.asc" -O mysql.tar.gz.asc
export GNUPGHOME="$(mktemp -d)"
# gpg: key 5072E1F5: public key "MySQL Release Engineering <mysql-build@oss.oracle.com>" imported
gpg --keyserver ha.pool.sks-keyservers.net --recv-keys A4A9406876FCBD3C456770C88C718D3B5072E1F5
gpg --batch --verify mysql.tar.gz.asc mysql.tar.gz
rm -r "$GNUPGHOME" mysql.tar.gz.asc
mkdir -p /usr/local/mysql
tar -xzf mysql.tar.gz -C /usr/local/mysql --strip-components=1
rm mysql.tar.gz
rm -rf /usr/local/mysql/mysql-test /usr/local/mysql/sql-bench
rm -rf /usr/local/mysql/bin/*-debug /usr/local/mysql/bin/*_embedded
find /usr/local/mysql -type f -name "*.a" -delete

export PATH=$PATH:/usr/local/mysql/bin:/usr/local/mysql/scripts

# create default configuration file
mkdir -p /etc/mysql/conf.d
{
    echo '[mysqld]';
    echo 'skip-host-cache';
    echo 'skip-name-resolve';
    echo 'datadir = /var/lib/mysql';
    echo '!includedir /etc/mysql/conf.d/';
} > /etc/mysql/my.cnf

mkdir -p /var/lib/mysql /var/run/mysqld
chown -R mysql:mysql /var/lib/mysql /var/run/mysqld
chmod 777 /var/run/mysqld
