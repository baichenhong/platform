#!/bin/bash -e

# Required ENV vars:
#   JAVA_HOME = location of a JDK home dir
#
# Optional ENV vars:
#   CLOUDWAY_HOME = location of cloudway's installation home dir
#

if [ -z "$CLOUDWAY_HOME" ]; then
  # resolve links - $0 may be a link to cloudway's home
  PRG="$0"

  # need this for relative symlinks
  while [ -h "$PRG" ]; do
    link=$(readlink "$PRG")
    if expr "$link" : '/.*' > /dev/null; then
      PRG="$link"
    else
      PRG=$(dirname "$PRG")/$link
    fi
  done

  # make it fully qualified
  CLOUDWAY_HOME=$(cd "$(dirname "$PRG")/.." && pwd)
fi

if [ -z "$JAVA_HOME" -a -x /usr/sbin/alternatives ]; then
  JAVA_HOME=$(/usr/sbin/alternatives --list | grep '^java_sdk_1\.8\.0' | head -n 1 | awk '{print $3}')
fi

if [ -z "$JAVA_CMD" ]; then
  if [ -n "$JAVA_HOME" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
    else
      JAVACMD="$JAVA_HOME/bin/java"
    fi
  else
    JAVACMD="`which java`"
  fi
fi

if [ ! -x "$JAVACMD" ]; then
  echo "Error: JAVA_HOME is not defined correctly."
  echo "       Cannot execute $JAVACMD"
  exit 1
fi

if [ -z "$CLOUDWAY_CLASSPATH" ]; then
  CLOUDWAY_CLASSPATH=$(echo $CLOUDWAY_HOME/lib/*.jar | tr ' ' ':')
fi

exec "$JAVACMD" -classpath "$CLOUDWAY_CLASSPATH" -DCLOUDWAY_HOME=$CLOUDWAY_HOME "$@"
